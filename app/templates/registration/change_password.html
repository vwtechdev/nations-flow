{% extends 'pages/index.html' %}
{% load static %}

{% block extra_head %}
<style>
    body {
        overflow: hidden !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .container-fluid {
        height: 100vh !important;
        overflow: hidden !important;
    }
    
    .row {
        height: 100vh !important;
        margin: 0 !important;
    }
    
    /* Hide sidebar and adjust main content for login page */
    .sidebar {
        display: none !important;
    }
    
    .main-content {
        margin-left: 0 !important;
        width: 100% !important;
    }
    
    /* Hide floating action button on login page */
    .floating-action-btn,
    .floating-action-menu {
        display: none !important;
    }
    
    /* Password toggle button styles */
    .password-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #6c757d;
        padding: 5px;
        border-radius: 4px;
        cursor: pointer;
        z-index: 10;
        transition: all 0.2s ease;
    }
    
    .password-toggle:hover {
        background-color: rgba(103, 58, 183, 0.1);
        color: var(--primary-color);
    }
    
    .password-toggle:focus {
        outline: none;
        box-shadow: 0 0 0 2px rgba(103, 58, 183, 0.25);
    }
    
    /* Position the password field container */
    .form-floating {
        position: relative;
    }
    
    /* Ensure the password input has proper padding for the button */
    .form-floating input[type="password"],
    .form-floating input[type="text"] {
        padding-right: 40px;
    }
    
    /* Password requirements styles */
    .password-requirements {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }
    
    .password-requirements h6 {
        color: #495057;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .password-requirements ul {
        margin-bottom: 0;
        padding-left: 1.25rem;
    }
    
    .password-requirements li {
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .password-requirements li.valid {
        color: #198754;
    }
    
    .password-requirements li.invalid {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center align-items-center h-100">
    <div class="col-md-6 col-lg-5 col-xl-4">
        <div class="login-card">
            <div class="login-header text-center mb-4">
                <div class="login-logo mb-3">
                    <img src="{% static 'img/icon.svg' %}" alt="Logo" class="img-fluid">
                </div>
                <h4 class="login-title">Alterar Senha</h4>
                {% if force_change %}
                <p class="login-subtitle">Esta é sua primeira vez no sistema. Você deve alterar sua senha para continuar.</p>
                {% else %}
                <p class="login-subtitle">Digite sua nova senha</p>
                {% endif %}
            </div>
            
            <form method="post" class="login-form">
                {% csrf_token %}
                
                <div class="password-requirements">
                    <h6><i class="bi bi-shield-lock"></i> Requisitos de Segurança</h6>
                    <ul>
                        <li id="req-length">Pelo menos 8 caracteres</li>
                        <li id="req-uppercase">Uma letra maiúscula</li>
                        <li id="req-lowercase">Uma letra minúscula</li>
                        <li id="req-number">Um número</li>
                        <li id="req-symbol">Um símbolo (!@#$%^&*)</li>
                    </ul>
                </div>
                
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" name="{{form.new_password1.name}}" id="id_new_password1" placeholder="Nova senha" onkeyup="validatePassword()">
                    <label for="id_new_password1">
                        <i class="bi bi-lock"></i> {{form.new_password1.label}}
                    </label>
                    <button type="button" class="btn btn-link password-toggle" onclick="togglePassword('id_new_password1')">
                        <i class="bi bi-eye" id="password-icon-1"></i>
                    </button>
                </div>
                
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" name="{{form.new_password2.name}}" id="id_new_password2" placeholder="Confirme a nova senha">
                    <label for="id_new_password2">
                        <i class="bi bi-lock-fill"></i> {{form.new_password2.label}}
                    </label>
                    <button type="button" class="btn btn-link password-toggle" onclick="togglePassword('id_new_password2')">
                        <i class="bi bi-eye" id="password-icon-2"></i>
                    </button>
                </div>
                
                {% if form.errors %}
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        {% for field, errors in form.errors.items %}
                            {% for error in errors %}
                                {{ error }}
                            {% endfor %}
                        {% endfor %}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endif %}
                
                <div class="d-grid mb-3">
                    <button class="btn btn-primary btn-lg login-btn" type="submit">
                        <i class="bi bi-check-circle"></i> Alterar Senha
                    </button>
                </div>
            </form>
            
            <div class="login-footer text-center">
                <p class="text-muted mb-0">
                    <i class="bi bi-shield-check"></i> Sistema seguro
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
// Função para alternar a visibilidade da senha
function togglePassword(inputId) {
    const input = document.getElementById(inputId);
    const icon = document.getElementById(inputId === 'id_new_password1' ? 'password-icon-1' : 'password-icon-2');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.classList.remove('bi-eye');
        icon.classList.add('bi-eye-slash');
    } else {
        input.type = 'password';
        icon.classList.remove('bi-eye-slash');
        icon.classList.add('bi-eye');
    }
}

// Função para validar a senha em tempo real
function validatePassword() {
    const password = document.getElementById('id_new_password1').value;
    
    // Verificar cada requisito
    const lengthValid = password.length >= 8;
    const uppercaseValid = /[A-Z]/.test(password);
    const lowercaseValid = /[a-z]/.test(password);
    const numberValid = /\d/.test(password);
    const symbolValid = /[!@#$%^&*(),.?":{}|<>]/.test(password);
    
    // Atualizar visual dos requisitos
    document.getElementById('req-length').className = lengthValid ? 'valid' : 'invalid';
    document.getElementById('req-uppercase').className = uppercaseValid ? 'valid' : 'invalid';
    document.getElementById('req-lowercase').className = lowercaseValid ? 'valid' : 'invalid';
    document.getElementById('req-number').className = numberValid ? 'valid' : 'invalid';
    document.getElementById('req-symbol').className = symbolValid ? 'valid' : 'invalid';
}

// Adicionar evento de clique ao botão de toggle
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.querySelector('.password-toggle');
    if (toggleButton) {
        toggleButton.addEventListener('click', function(e) {
            e.preventDefault();
            togglePassword();
        });
    }
});
</script>
{% endblock %} 